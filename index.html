<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gravity Flip - Free HTML5 Game</title>
<meta name="description" content="Play Gravity Flip - Tap to flip gravity up/down while dodging obstacles from both sides. Collect stars for bonus points. Obstacles speed up gradually.">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0e1a">
<meta property="og:type" content="website">
<meta property="og:title" content="Gravity Flip - Free HTML5 Game">
<meta property="og:description" content="Tap to flip gravity up/down while dodging obstacles. Collect orbs, build combos, trigger Burst Flips!">
<meta property="og:url" content="https://balinti.github.io/gravity-flip/">
<meta property="og:image" content="https://balinti.github.io/gravity-flip/og-image.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Gravity Flip - Free HTML5 Game">
<meta name="twitter:description" content="Tap to flip gravity up/down while dodging obstacles. Collect orbs, build combos, trigger Burst Flips!">
<meta name="twitter:image" content="https://balinti.github.io/gravity-flip/og-image.png">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4099346100621490" crossorigin="anonymous"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow-x:hidden;background:#0a0e1a;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;color:#c8d0e0}
body{display:flex;flex-direction:column;align-items:center}
#game-wrap{position:relative;width:min(420px,100vw);height:min(750px,100vh);margin:0 auto;overflow:hidden;touch-action:none;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none}
canvas{display:block;width:100%;height:100%;touch-action:none}
.overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;pointer-events:auto;transition:opacity .35s}
.overlay.hidden{opacity:0;pointer-events:none}
#start-overlay{background:rgba(8,12,28,.9)}
#start-overlay h1{font-size:2.3em;font-weight:800;letter-spacing:-.02em;background:linear-gradient(135deg,#60f0ff,#a07cff,#ff6098);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:6px}
#start-overlay .sub{font-size:1em;color:#7888a8;margin-bottom:24px;letter-spacing:1px}
#start-overlay .tap{font-size:1.2em;color:#e0e8ff;animation:pulse 1.6s ease-in-out infinite}
#start-overlay .how{font-size:.8em;color:#506080;margin-top:20px;max-width:280px;text-align:center;line-height:1.55}
#challenge-info{color:#ffc060;font-size:.9em;margin-bottom:14px;display:none;text-align:center}
@keyframes pulse{0%,100%{opacity:.5;transform:scale(1)}50%{opacity:1;transform:scale(1.03)}}
#go-overlay{background:rgba(8,12,28,.92)}
#go-overlay h2{font-size:1.8em;font-weight:700;color:#ff6080;margin-bottom:14px}
#go-overlay .stat{font-size:1em;color:#9aaccc;margin:3px 0}
#go-overlay .stat b{color:#e0e8ff}
#go-overlay .tap{font-size:1.1em;color:#c0c8e0;margin-top:18px;animation:pulse 1.6s ease-in-out infinite}
.go-buttons{display:flex;gap:12px;margin-top:14px}
.go-btn{padding:10px 22px;border:none;border-radius:8px;font-size:.92em;font-weight:600;cursor:pointer;transition:transform .12s}
.go-btn:active{transform:scale(.94)}
#btn-share{background:linear-gradient(135deg,#5080ff,#8060ff);color:#fff}
#btn-mute{background:rgba(255,255,255,.1);color:#b0b8d0}
#toast{position:fixed;bottom:60px;left:50%;transform:translateX(-50%);background:rgba(40,50,80,.95);color:#e0e8ff;padding:10px 24px;border-radius:8px;font-size:.88em;opacity:0;transition:opacity .3s;pointer-events:none;z-index:100}
#toast.show{opacity:1}
.seo{max-width:420px;margin:20px auto 40px;padding:0 16px;font-size:.82em;line-height:1.6;color:#506878}
.seo h2{font-size:1.05em;color:#7888a8;margin:14px 0 5px}
.seo p,.seo ul{margin-bottom:6px}
.seo ul{padding-left:16px}
.seo li{margin-bottom:3px}
</style>
</head>
<body>
<div id="game-wrap">
<canvas id="c"></canvas>
<div id="start-overlay" class="overlay">
<h1>Gravity Flip</h1>
<div class="sub">Combo Rails</div>
<div id="challenge-info"></div>
<div class="tap">Tap to Start</div>
<div class="how">Tap or press Space to flip between rails. Dodge gates, collect orbs, build combos. Fill the charge meter for a Burst Flip!</div>
</div>
<div id="go-overlay" class="overlay hidden">
<h2>Game Over</h2>
<div class="stat">Score: <b id="go-score">0</b></div>
<div class="stat">Best: <b id="go-best">0</b></div>
<div class="stat">Max Multiplier: <b id="go-mult">x1</b></div>
<div class="go-buttons">
<button class="go-btn" id="btn-share">Share</button>
<button class="go-btn" id="btn-mute">Sound: ON</button>
</div>
<div class="tap">Tap to Retry</div>
</div>
</div>
<div id="toast"></div>
<section class="seo">
<h2>How to Play Gravity Flip</h2>
<p>Tap the screen or press Space/Enter to flip your player between the top and bottom rails. Dodge incoming gates by switching to the safe rail before they reach you. Gates are telegraphed so you can read them about 1 second ahead.</p>
<h2>Tips for High Combos</h2>
<ul>
<li>Squeeze through tight near-miss zones to boost your score multiplier.</li>
<li>Collect glowing orbs to fill your Charge meter (3 pips max).</li>
<li>Keep your combo alive — the multiplier drops after 2 seconds without a near-miss or orb.</li>
<li>Higher multipliers mean massive score gains from distance alone.</li>
</ul>
<h2>What is Burst Flip?</h2>
<p>When all 3 Charge pips are full, your next tap triggers a Burst Flip: you flip with a brief shield (0.25s invincibility) and slow-motion effect, letting you blast through obstacles safely.</p>
<h2>FAQ</h2>
<p><strong>Is it free?</strong> Yes, 100% free — plays right in your browser.</p>
<p><strong>Mobile controls?</strong> Tap anywhere on screen. Desktop: Space or Enter.</p>
<p><strong>Daily challenge?</strong> Patterns are seeded by date, so everyone faces the same obstacle sequence each day. Share your score to challenge friends!</p>
</section>

<script>
(function(){
"use strict";

/* ===== Helpers ===== */
var clamp=function(v,lo,hi){return v<lo?lo:v>hi?hi:v};
var lerp=function(a,b,t){return a+(b-a)*t};

/* ===== Seeded RNG (mulberry32) ===== */
function hashStr(s){var h=0;for(var i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0}return h>>>0}
function mulberry32(seed){return function(){seed|=0;seed=seed+0x6D2B79F5|0;var t=Math.imul(seed^seed>>>15,1|seed);t^=t+Math.imul(t^t>>>7,61|t);return((t^t>>>14)>>>0)/4294967296}}

/* ===== URL Params ===== */
var urlP=new URLSearchParams(location.search);
var challengeScore=urlP.get('challengeScore')?parseInt(urlP.get('challengeScore'),10):0;
var challengeMult=urlP.get('challengeMult')?parseInt(urlP.get('challengeMult'),10):0;
var seedParam=urlP.get('seed');
var today=new Date();
var dailySeed=today.getFullYear()+'-'+String(today.getMonth()+1).padStart(2,'0')+'-'+String(today.getDate()).padStart(2,'0');
var seedStr=(seedParam==='DAILY'||!seedParam)?dailySeed:seedParam;
var sRng;

/* ===== Canvas ===== */
var canvas=document.getElementById('c');
var ctx=canvas.getContext('2d');
var wrap=document.getElementById('game-wrap');
var W,H,dpr,railTopY,railBotY,playerX;

function resize(){
  var r=wrap.getBoundingClientRect();
  W=r.width; H=r.height;
  dpr=Math.min(window.devicePixelRatio||1,2);
  canvas.width=Math.round(W*dpr);
  canvas.height=Math.round(H*dpr);
  canvas.style.width=W+'px';
  canvas.style.height=H+'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);
  railTopY=140;
  railBotY=H-140;
  playerX=W*0.28;
}
resize();
var resizeTimer;
window.addEventListener('resize',function(){clearTimeout(resizeTimer);resizeTimer=setTimeout(resize,100)});

/* ===== DOM Refs ===== */
var startOv=document.getElementById('start-overlay');
var goOv=document.getElementById('go-overlay');
var goScoreEl=document.getElementById('go-score');
var goBestEl=document.getElementById('go-best');
var goMultEl=document.getElementById('go-mult');
var btnShare=document.getElementById('btn-share');
var btnMute=document.getElementById('btn-mute');
var toastEl=document.getElementById('toast');
var challengeInfo=document.getElementById('challenge-info');

if(challengeScore>0){
  challengeInfo.style.display='block';
  challengeInfo.textContent='Challenge: beat '+challengeScore+' pts (x'+challengeMult+' mult)';
}

/* ===== Audio ===== */
var muted=false;
var audioCtx=null;
function ensureAudio(){if(!audioCtx)try{audioCtx=new (window.AudioContext||window.webkitAudioContext)()}catch(e){}}
function tone(freq,dur,vol,type){
  if(muted||!audioCtx)return;
  try{
    var o=audioCtx.createOscillator();
    var g=audioCtx.createGain();
    o.type=type||'square';
    o.frequency.value=freq;
    g.gain.setValueAtTime(vol||0.06,audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+(dur||0.1));
    o.connect(g);g.connect(audioCtx.destination);
    o.start();o.stop(audioCtx.currentTime+(dur||0.1));
  }catch(e){}
}
function sfxFlip(){tone(520,0.06,0.06,'square')}
function sfxNearMiss(){tone(880,0.1,0.07,'sine')}
function sfxOrb(){tone(660,0.12,0.07,'triangle');setTimeout(function(){tone(990,0.08,0.05,'triangle')},50)}
function sfxBurst(){tone(440,0.2,0.08,'sawtooth');setTimeout(function(){tone(660,0.12,0.06,'sine')},70)}
function sfxDeath(){tone(180,0.3,0.1,'sawtooth');setTimeout(function(){tone(120,0.25,0.08,'square')},80)}

btnMute.addEventListener('click',function(e){
  e.stopPropagation();
  muted=!muted;
  btnMute.textContent='Sound: '+(muted?'OFF':'ON');
});

/* ===== Game Constants ===== */
var PLAYER_R=12;
var GRACE_DUR=0.12;
var COMBO_TIMEOUT=2.0;
var SHIELD_DUR=0.25;
var SLOW_DUR=0.25;
var SLOW_FACTOR=0.55;
var MAX_CHARGES=3;
var NEAR_MISS_DIST=24;

/* ===== Game State ===== */
var state='start';
var score,bestScore,elapsed,multiplier,maxMult,comboTimer;
var charges,shieldTimer,slowTimer,graceTimer;
var onTop;
var gates,orbs,particles,trail;
var speed,baseSpeed;
var shakeX,shakeY,shakeDur,shakeIntensity;
var baseHue;
var spawnCursor;
var lastTime=0;
var deathFreezeUntil=0;

bestScore=parseInt(localStorage.getItem('gflip_best'))||0;

/* ===== Patterns ===== */
/* rail: 'top' or 'bot' - which rail is BLOCKED
   type: 'static' or 'shutter'
   d: x offset from pattern start */
var PATTERNS=[
  /* Easy: single blocker */
  {w:1,g:[{rail:'bot',type:'static',d:0}],orb:true},
  {w:1,g:[{rail:'top',type:'static',d:0}],orb:true},
  /* Easy: alternating pair */
  {w:2,g:[{rail:'bot',type:'static',d:0},{rail:'top',type:'static',d:150}],orb:true},
  {w:2,g:[{rail:'top',type:'static',d:0},{rail:'bot',type:'static',d:150}],orb:true},
  /* Medium: single shutter */
  {w:3,g:[{rail:'bot',type:'shutter',d:0}],orb:true},
  {w:3,g:[{rail:'top',type:'shutter',d:0}],orb:true},
  /* Medium: double quick */
  {w:4,g:[{rail:'bot',type:'static',d:0},{rail:'top',type:'static',d:95}],orb:false},
  {w:4,g:[{rail:'top',type:'static',d:0},{rail:'bot',type:'static',d:95}],orb:false},
  /* Hard: shutter + static */
  {w:5,g:[{rail:'top',type:'shutter',d:0},{rail:'bot',type:'static',d:130}],orb:true},
  {w:5,g:[{rail:'bot',type:'shutter',d:0},{rail:'top',type:'static',d:130}],orb:true},
  /* Hard: simultaneous (must time shutter) */
  {w:6,g:[{rail:'bot',type:'static',d:0},{rail:'top',type:'shutter',d:0}],orb:false},
  {w:6,g:[{rail:'top',type:'static',d:0},{rail:'bot',type:'shutter',d:0}],orb:false},
  /* Expert: triple */
  {w:7,g:[{rail:'bot',type:'static',d:0},{rail:'top',type:'static',d:110},{rail:'bot',type:'shutter',d:220}],orb:true},
  {w:7,g:[{rail:'top',type:'shutter',d:0},{rail:'bot',type:'static',d:110},{rail:'top',type:'static',d:220}],orb:true},
];

function pickPattern(){
  var maxW=clamp(1+elapsed*0.1,1,7);
  var pool=[];
  for(var i=0;i<PATTERNS.length;i++){
    if(PATTERNS[i].w<=maxW+0.5) pool.push(PATTERNS[i]);
  }
  if(pool.length===0) pool.push(PATTERNS[0]);
  var idx=Math.floor(sRng()*pool.length);
  return pool[idx];
}

function getSpacing(){
  return clamp(380-0.9*elapsed,260,380);
}

function spawnPatternAt(baseX){
  var pat=pickPattern();
  var gateH=68;
  for(var i=0;i<pat.g.length;i++){
    var gd=pat.g[i];
    var gx=baseX+gd.d;
    var gy;
    if(gd.rail==='top'){
      gy=railTopY-gateH/2;
    } else {
      gy=railBotY-gateH/2;
    }
    gates.push({
      x:gx, y:gy, w:28, h:gateH,
      type:gd.type, rail:gd.rail,
      shutterPhase:sRng()*Math.PI*2,
      shutterOpen:false,
      active:true,
      nearMissed:false
    });
  }
  /* Orb on safe rail */
  if(pat.orb && sRng()<0.4){
    var lastGate=pat.g[pat.g.length-1];
    var orbRail=(lastGate.rail==='top')?'bot':'top';
    var orbY=(orbRail==='top')?railTopY:railBotY;
    var orbX=baseX+lastGate.d+14;
    orbs.push({x:orbX,y:orbY,r:10,collected:false});
  }
  /* Return pattern width */
  var maxD=0;
  for(var j=0;j<pat.g.length;j++){
    if(pat.g[j].d>maxD) maxD=pat.g[j].d;
  }
  return maxD+28;
}

/* ===== Particles ===== */
function addP(x,y,vx,vy,life,r,hue,type){
  if(particles.length>220) return;
  particles.push({x:x,y:y,vx:vx,vy:vy,life:life,maxLife:life,r:r,hue:hue,type:type||'dot',alpha:1});
}

function spawnFlipSparks(x,y,dir){
  for(var i=0;i<9;i++){
    var a=Math.random()*Math.PI*2;
    var sp=80+Math.random()*160;
    addP(x,y,Math.cos(a)*sp,Math.sin(a)*sp+dir*-50,0.2+Math.random()*0.25,2+Math.random()*2.5,baseHue+Math.random()*30-15,'dot');
  }
}
function spawnNearMissRing(x,y){
  for(var i=0;i<14;i++){
    var a=(i/14)*Math.PI*2;
    addP(x,y,Math.cos(a)*160,Math.sin(a)*160,0.3,2.5,50,'dot');
  }
}
function spawnBurstRing(x,y){
  for(var i=0;i<22;i++){
    var a=(i/22)*Math.PI*2;
    var sp=130+Math.random()*150;
    addP(x,y,Math.cos(a)*sp,Math.sin(a)*sp,0.45,3+Math.random()*3,(baseHue+180)%360,'streak');
  }
}
function spawnDeathShards(x,y){
  for(var i=0;i<18;i++){
    var a=Math.random()*Math.PI*2;
    var sp=60+Math.random()*220;
    addP(x,y,Math.cos(a)*sp,Math.sin(a)*sp,0.4+Math.random()*0.5,3+Math.random()*5,0,'dot');
  }
}
function spawnOrbCollect(x,y){
  for(var i=0;i<8;i++){
    var a=Math.random()*Math.PI*2;
    addP(x,y,Math.cos(a)*120,Math.sin(a)*120,0.3,2+Math.random()*2,160,'dot');
  }
}
function spawnShieldSparks(x,y){
  for(var i=0;i<6;i++){
    var a=Math.random()*Math.PI*2;
    addP(x,y,Math.cos(a)*100,Math.sin(a)*100,0.2,2+Math.random()*2,200,'dot');
  }
}

/* ===== Shake ===== */
function triggerShake(intensity,dur){
  shakeIntensity=Math.max(shakeIntensity||0,intensity);
  shakeDur=Math.max(shakeDur||0,dur);
}

/* ===== Init / Reset ===== */
function initGame(){
  score=0; elapsed=0; multiplier=1; maxMult=1; comboTimer=0;
  charges=0; shieldTimer=0; slowTimer=0; graceTimer=0;
  onTop=false;
  gates=[]; orbs=[]; particles=[]; trail=[];
  speed=260;
  shakeX=0; shakeY=0; shakeDur=0; shakeIntensity=0;
  baseHue=200;
  deathFreezeUntil=0;

  sRng=mulberry32(hashStr(seedStr));

  /* Pre-spawn gates */
  spawnCursor=W+80;
  for(var i=0;i<5;i++){
    var pw=spawnPatternAt(spawnCursor);
    spawnCursor+=pw+getSpacing();
  }
}

/* ===== Input ===== */
function doFlip(){
  if(state==='start'){
    ensureAudio();
    state='playing';
    startOv.classList.add('hidden');
    goOv.classList.add('hidden');
    initGame();
    return;
  }
  if(state==='gameover'){
    if(performance.now()<deathFreezeUntil) return;
    ensureAudio();
    state='playing';
    goOv.classList.add('hidden');
    startOv.classList.add('hidden');
    initGame();
    return;
  }
  if(state==='playing'){
    var burst=false;
    if(charges>=MAX_CHARGES){
      charges=0;
      shieldTimer=SHIELD_DUR;
      slowTimer=SLOW_DUR;
      burst=true;
      sfxBurst();
      var py=onTop?railTopY:railBotY;
      spawnBurstRing(playerX,py);
      triggerShake(4,0.18);
    } else {
      sfxFlip();
    }
    onTop=!onTop;
    graceTimer=GRACE_DUR;
    var py2=onTop?railTopY:railBotY;
    spawnFlipSparks(playerX,py2,onTop?1:-1);
  }
}

canvas.addEventListener('pointerdown',function(e){e.preventDefault();doFlip()},{passive:false});
document.addEventListener('keydown',function(e){
  if(e.code==='Space'||e.code==='Enter'){e.preventDefault();doFlip()}
});

/* ===== Share ===== */
btnShare.addEventListener('click',function(e){
  e.stopPropagation();
  var s=Math.floor(score);
  var url=location.origin+location.pathname+'?challengeScore='+s+'&challengeMult='+maxMult+'&seed=DAILY';
  var txt='I scored '+s+' (x'+maxMult+' max mult) in Gravity Flip: Combo Rails! Can you beat me? '+url;
  if(navigator.share){
    navigator.share({title:'Gravity Flip',text:txt,url:url}).catch(function(){});
  } else if(navigator.clipboard){
    navigator.clipboard.writeText(txt).then(function(){showToast('Link copied!')}).catch(function(){showToast('Could not copy')});
  } else {
    showToast('Share not available');
  }
});

function showToast(msg){
  toastEl.textContent=msg;
  toastEl.classList.add('show');
  setTimeout(function(){toastEl.classList.remove('show')},2200);
}

/* ===== Update ===== */
function update(rawDt){
  if(state!=='playing') return;

  var now=performance.now();
  if(now<deathFreezeUntil) return;

  /* Slow-mo factor */
  var wf=(slowTimer>0)?SLOW_FACTOR:1;
  var dt=rawDt*wf;
  elapsed+=dt;

  /* Difficulty */
  speed=260+18*Math.sqrt(elapsed);
  var spacing=getSpacing();

  /* Score */
  score+=(speed*dt)*0.06*multiplier;

  /* Combo decay */
  comboTimer+=dt;
  if(comboTimer>COMBO_TIMEOUT){
    multiplier=1;
    comboTimer=0;
  }

  /* Timers */
  if(graceTimer>0) graceTimer-=rawDt;
  if(shieldTimer>0) shieldTimer-=rawDt;
  if(slowTimer>0) slowTimer-=rawDt;

  /* HSL cycling */
  baseHue=(baseHue+dt*14)%360;

  /* Shake decay */
  if(shakeDur>0){
    shakeDur-=rawDt;
    var t=clamp(shakeDur/0.35,0,1);
    shakeX=(Math.random()-0.5)*shakeIntensity*t*2;
    shakeY=(Math.random()-0.5)*shakeIntensity*t*2;
    if(shakeDur<=0){shakeX=0;shakeY=0;shakeIntensity=0}
  }

  var dx=speed*dt;

  /* Move gates */
  for(var i=gates.length-1;i>=0;i--){
    var g=gates[i];
    g.x-=dx;
    if(g.type==='shutter'){
      g.shutterPhase+=dt*3.5;
      g.shutterOpen=Math.sin(g.shutterPhase)>0.3;
    }
    if(g.x<-60){gates[i]=gates[gates.length-1];gates.pop()}
  }

  /* Move orbs */
  for(var i=orbs.length-1;i>=0;i--){
    var o=orbs[i];
    o.x-=dx;
    if(o.x<-30){orbs[i]=orbs[orbs.length-1];orbs.pop();continue}
    if(!o.collected){
      var py=onTop?railTopY:railBotY;
      var dist=Math.hypot(o.x-playerX,o.y-py);
      if(dist<o.r+PLAYER_R){
        o.collected=true;
        charges=Math.min(charges+1,MAX_CHARGES);
        score+=80*multiplier;
        comboTimer=0;
        multiplier=clamp(multiplier+0.3,1,12);
        if(multiplier>maxMult) maxMult=Math.floor(multiplier*10)/10;
        sfxOrb();
        spawnOrbCollect(o.x,o.y);
      }
    }
  }

  /* Spawn new patterns */
  spawnCursor-=dx;
  if(spawnCursor<W+100){
    var pw=spawnPatternAt(spawnCursor+spacing);
    spawnCursor+=pw+spacing;
  }

  /* Collision */
  var py=onTop?railTopY:railBotY;
  for(var i=0;i<gates.length;i++){
    var g=gates[i];
    if(!g.active) continue;
    if(g.type==='shutter'&&g.shutterOpen) continue;

    /* Circle vs rect */
    var nearX=clamp(playerX,g.x,g.x+g.w);
    var nearY=clamp(py,g.y,g.y+g.h);
    var dd=Math.hypot(playerX-nearX,py-nearY);

    if(dd<PLAYER_R){
      /* Grace: ignore */
      if(graceTimer>0) continue;
      /* Shield: sparks + deactivate gate */
      if(shieldTimer>0){
        spawnShieldSparks(playerX,py);
        triggerShake(3,0.1);
        g.active=false;
        continue;
      }
      /* Death */
      doDeath(py);
      return;
    }

    /* Near-miss */
    if(dd<PLAYER_R+NEAR_MISS_DIST && dd>=PLAYER_R && !g.nearMissed){
      if(graceTimer<=0){
        g.nearMissed=true;
        score+=120*multiplier;
        comboTimer=0;
        multiplier=clamp(multiplier+0.5,1,12);
        if(multiplier>maxMult) maxMult=Math.floor(multiplier*10)/10;
        spawnNearMissRing(playerX,py);
        triggerShake(2,0.08);
        sfxNearMiss();
      }
    }
  }

  /* Trail */
  trail.push({x:playerX,y:py,t:0.3,grace:graceTimer>0});
  for(var i=trail.length-1;i>=0;i--){
    trail[i].t-=rawDt;
    trail[i].x-=dx*0.25;
    if(trail[i].t<=0) trail.splice(i,1);
  }

  /* Particles */
  for(var i=particles.length-1;i>=0;i--){
    var p=particles[i];
    p.x+=p.vx*rawDt;
    p.y+=p.vy*rawDt;
    p.life-=rawDt;
    p.alpha=clamp(p.life/p.maxLife,0,1);
    if(p.life<=0){particles[i]=particles[particles.length-1];particles.pop()}
  }
}

function doDeath(py){
  state='gameover';
  deathFreezeUntil=performance.now()+600;
  spawnDeathShards(playerX,py);
  triggerShake(9,0.4);
  sfxDeath();
  var s=Math.floor(score);
  if(s>bestScore){bestScore=s;localStorage.setItem('gflip_best',String(bestScore))}
  goScoreEl.textContent=String(s);
  goBestEl.textContent=String(bestScore);
  var mm=Math.max(maxMult,1);
  goMultEl.textContent='x'+(mm===Math.floor(mm)?String(mm):mm.toFixed(1));
  setTimeout(function(){goOv.classList.remove('hidden')},500);
}

/* ===== Draw ===== */
function draw(){
  ctx.save();
  ctx.setTransform(dpr,0,0,dpr,0,0);

  /* Shake */
  if(shakeDur>0){
    ctx.translate(shakeX,shakeY);
  }

  /* Background */
  var bg=ctx.createLinearGradient(0,0,0,H);
  bg.addColorStop(0,'hsl('+((baseHue+20)%360)+',30%,5%)');
  bg.addColorStop(0.5,'hsl('+((baseHue+10)%360)+',25%,7%)');
  bg.addColorStop(1,'hsl('+((baseHue-5+360)%360)+',28%,5%)');
  ctx.fillStyle=bg;
  ctx.fillRect(-20,-20,W+40,H+40);

  /* Multiplier tint */
  if(state==='playing'&&multiplier>1.5){
    var ta=clamp((multiplier-1.5)*0.015,0,0.06);
    ctx.fillStyle='hsla('+((baseHue+60)%360)+',55%,50%,'+ta+')';
    ctx.fillRect(0,0,W,H);
  }

  if(state==='playing'||state==='gameover'){
    drawRails();
    drawSafeHighlights();
    drawGates();
    drawOrbs();
    drawTrail();
    if(state==='playing') drawPlayer();
    drawParticles();
    drawHUD();
  } else {
    /* Start screen: draw rails + demo player */
    drawRails();
    drawDemoPlayer();
    drawParticles();
  }

  ctx.restore();
}

function drawRails(){
  var hTop=(baseHue+160)%360;
  var hBot=(baseHue+20)%360;

  /* Top rail glow */
  ctx.save();
  ctx.shadowColor='hsl('+hTop+',70%,55%)';
  ctx.shadowBlur=16;
  ctx.strokeStyle='hsla('+hTop+',60%,50%,0.5)';
  ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(0,railTopY);ctx.lineTo(W,railTopY);ctx.stroke();
  ctx.restore();
  ctx.strokeStyle='hsla('+hTop+',50%,60%,0.8)';
  ctx.lineWidth=1.5;
  ctx.beginPath();ctx.moveTo(0,railTopY);ctx.lineTo(W,railTopY);ctx.stroke();

  /* Bottom rail glow */
  ctx.save();
  ctx.shadowColor='hsl('+hBot+',70%,55%)';
  ctx.shadowBlur=16;
  ctx.strokeStyle='hsla('+hBot+',60%,50%,0.5)';
  ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(0,railBotY);ctx.lineTo(W,railBotY);ctx.stroke();
  ctx.restore();
  ctx.strokeStyle='hsla('+hBot+',50%,60%,0.8)';
  ctx.lineWidth=1.5;
  ctx.beginPath();ctx.moveTo(0,railBotY);ctx.lineTo(W,railBotY);ctx.stroke();
}

function drawSafeHighlights(){
  for(var i=0;i<gates.length;i++){
    var g=gates[i];
    if(!g.active) continue;
    if(g.x>playerX && g.x<playerX+speed*1.0){
      var safeY=(g.rail==='top')?railBotY:railTopY;
      ctx.fillStyle='hsla('+((baseHue+90)%360)+',50%,55%,0.035)';
      ctx.fillRect(g.x-8,safeY-35,g.w+16,70);
    }
  }
}

function drawGates(){
  var now=performance.now();
  for(var i=0;i<gates.length;i++){
    var g=gates[i];
    if(g.x>W+40||g.x<-60) continue;

    if(g.type==='shutter'&&g.shutterOpen){
      /* Ghost outline for open shutter */
      ctx.strokeStyle='hsla(0,0%,40%,0.12)';
      ctx.lineWidth=1;
      ctx.strokeRect(g.x,g.y,g.w,g.h);
      /* Countdown ticks always visible */
      drawShutterTicks(g,now);
      continue;
    }

    var hue=(g.type==='shutter')?42:350;
    var sat=(g.type==='shutter')?'75%':'70%';
    var lit=(g.type==='shutter')?'52%':'42%';

    ctx.save();
    ctx.shadowColor='hsl('+hue+',80%,50%)';
    ctx.shadowBlur=10;
    ctx.fillStyle='hsla('+hue+','+sat+','+lit+',0.85)';
    ctx.fillRect(g.x,g.y,g.w,g.h);
    ctx.strokeStyle='hsla('+hue+',80%,60%,0.6)';
    ctx.lineWidth=1.5;
    ctx.strokeRect(g.x,g.y,g.w,g.h);
    ctx.restore();

    /* Danger marking on gate edges */
    ctx.fillStyle='hsla('+hue+',90%,70%,0.25)';
    ctx.fillRect(g.x+2,g.y+2,g.w-4,3);
    ctx.fillRect(g.x+2,g.y+g.h-5,g.w-4,3);

    if(g.type==='shutter'){
      drawShutterTicks(g,now);
    }
  }
}

function drawShutterTicks(g,now){
  var phase=(Math.sin(g.shutterPhase)+1)/2;
  for(var t=0;t<3;t++){
    var ty=g.y+g.h+6+t*7;
    var brightness=(t/3<phase)?0.75:0.15;
    ctx.fillStyle='hsla(50,80%,60%,'+brightness+')';
    ctx.fillRect(g.x+g.w/2-5,ty,10,3);
  }
}

function drawOrbs(){
  for(var i=0;i<orbs.length;i++){
    var o=orbs[i];
    if(o.collected) continue;
    if(o.x>W+30||o.x<-30) continue;
    ctx.beginPath();
    ctx.arc(o.x,o.y,o.r,0,Math.PI*2);
    var grad=ctx.createRadialGradient(o.x,o.y,0,o.x,o.y,o.r);
    grad.addColorStop(0,'hsla(160,90%,75%,0.9)');
    grad.addColorStop(1,'hsla(160,80%,40%,0.25)');
    ctx.fillStyle=grad;
    ctx.fill();
    /* Glow */
    ctx.beginPath();
    ctx.arc(o.x,o.y,o.r+7,0,Math.PI*2);
    ctx.fillStyle='hsla(160,80%,60%,0.12)';
    ctx.fill();
  }
}

function drawTrail(){
  for(var i=0;i<trail.length;i++){
    var t=trail[i];
    var a=clamp(t.t/0.3,0,1)*0.4;
    ctx.beginPath();
    ctx.arc(t.x,t.y,8*a+2,0,Math.PI*2);
    if(t.grace){
      ctx.fillStyle='rgba(255,255,255,'+a+')';
    } else {
      ctx.fillStyle='hsla('+baseHue+',70%,60%,'+a+')';
    }
    ctx.fill();
  }
}

function drawPlayer(){
  var py=onTop?railTopY:railBotY;

  /* Chromatic offset during slow-mo */
  if(slowTimer>0){
    ctx.beginPath();
    ctx.arc(playerX-2.5,py-1.5,PLAYER_R,0,Math.PI*2);
    ctx.fillStyle='rgba(255,50,50,0.28)';
    ctx.fill();
    ctx.beginPath();
    ctx.arc(playerX+2.5,py+1.5,PLAYER_R,0,Math.PI*2);
    ctx.fillStyle='rgba(50,50,255,0.28)';
    ctx.fill();
  }

  /* Main body */
  var grad=ctx.createRadialGradient(playerX,py,0,playerX,py,PLAYER_R);
  if(shieldTimer>0){
    grad.addColorStop(0,'rgba(255,255,255,0.95)');
    grad.addColorStop(1,'hsla('+baseHue+',80%,80%,0.5)');
    /* Shield ring */
    ctx.beginPath();
    ctx.arc(playerX,py,PLAYER_R+7,0,Math.PI*2);
    ctx.strokeStyle='hsla('+((baseHue+180)%360)+',90%,70%,0.45)';
    ctx.lineWidth=2.5;
    ctx.stroke();
  } else {
    grad.addColorStop(0,'hsla('+baseHue+',80%,82%,0.95)');
    grad.addColorStop(1,'hsla('+baseHue+',65%,48%,0.6)');
  }
  ctx.beginPath();
  ctx.arc(playerX,py,PLAYER_R,0,Math.PI*2);
  ctx.fillStyle=grad;
  ctx.fill();

  /* Outer glow */
  ctx.beginPath();
  ctx.arc(playerX,py,PLAYER_R+5,0,Math.PI*2);
  ctx.fillStyle='hsla('+baseHue+',70%,60%,0.1)';
  ctx.fill();
}

function drawDemoPlayer(){
  /* Gently bouncing demo player */
  var t=performance.now()*0.001;
  var demoY=(Math.sin(t*1.2)>0)?railTopY:railBotY;
  var grad=ctx.createRadialGradient(playerX,demoY,0,playerX,demoY,PLAYER_R);
  grad.addColorStop(0,'hsla('+baseHue+',80%,80%,0.7)');
  grad.addColorStop(1,'hsla('+baseHue+',65%,45%,0.3)');
  ctx.beginPath();
  ctx.arc(playerX,demoY,PLAYER_R,0,Math.PI*2);
  ctx.fillStyle=grad;
  ctx.fill();
  /* Ambient particles */
  if(Math.random()<0.06){
    addP(Math.random()*W,railTopY+Math.random()*(railBotY-railTopY),(Math.random()-0.5)*20,(Math.random()-0.5)*20,0.8+Math.random()*0.4,1.5+Math.random()*2,(baseHue+Math.random()*40)%360,'dot');
  }
}

function drawParticles(){
  for(var i=0;i<particles.length;i++){
    var p=particles[i];
    ctx.globalAlpha=p.alpha;
    if(p.type==='streak'){
      ctx.strokeStyle='hsl('+p.hue+',80%,65%)';
      ctx.lineWidth=p.r;
      ctx.beginPath();
      ctx.moveTo(p.x,p.y);
      ctx.lineTo(p.x-p.vx*0.02,p.y-p.vy*0.02);
      ctx.stroke();
    } else {
      ctx.beginPath();
      ctx.arc(p.x,p.y,Math.max(p.r*p.alpha,0.5),0,Math.PI*2);
      ctx.fillStyle='hsl('+p.hue+',80%,65%)';
      ctx.fill();
    }
  }
  ctx.globalAlpha=1;
}

function drawHUD(){
  if(state!=='playing') return;
  /* Score */
  ctx.font='bold 22px "Segoe UI",system-ui,sans-serif';
  ctx.fillStyle='rgba(224,232,255,0.9)';
  ctx.textAlign='left';
  ctx.textBaseline='top';
  ctx.fillText(String(Math.floor(score)),16,16);

  /* Multiplier */
  if(multiplier>1){
    ctx.font='bold 15px "Segoe UI",system-ui,sans-serif';
    ctx.fillStyle='hsla('+((baseHue+60)%360)+',80%,65%,0.9)';
    ctx.fillText('x'+multiplier.toFixed(1),16,42);
  }

  /* Combo decay bar */
  if(multiplier>1){
    var barW=56;
    var remain=clamp(1-comboTimer/COMBO_TIMEOUT,0,1);
    ctx.fillStyle='rgba(255,255,255,0.08)';
    ctx.fillRect(16,60,barW,4);
    ctx.fillStyle='hsla('+((baseHue+60)%360)+',70%,55%,0.7)';
    ctx.fillRect(16,60,barW*remain,4);
  }

  /* Charge pips (top-right) */
  ctx.textAlign='right';
  var pipStartX=W-16;
  for(var i=0;i<MAX_CHARGES;i++){
    var cx=pipStartX-i*20;
    ctx.beginPath();
    ctx.arc(cx,24,7,0,Math.PI*2);
    if(i<charges){
      ctx.fillStyle='hsla(160,80%,60%,0.9)';
      ctx.fill();
      ctx.strokeStyle='hsla(160,80%,70%,0.5)';
      ctx.lineWidth=1.5;
      ctx.stroke();
    } else {
      ctx.strokeStyle='rgba(255,255,255,0.18)';
      ctx.lineWidth=1.5;
      ctx.stroke();
    }
  }

  /* BURST READY label */
  if(charges>=MAX_CHARGES){
    var bAlpha=0.5+0.5*Math.sin(performance.now()*0.006);
    ctx.font='bold 10px "Segoe UI",system-ui,sans-serif';
    ctx.fillStyle='hsla(160,80%,65%,'+bAlpha+')';
    ctx.fillText('BURST READY',W-8,42);
  }
}

/* ===== Main Loop ===== */
function loop(now){
  requestAnimationFrame(loop);
  if(!lastTime){lastTime=now;return}
  var rawDt=(now-lastTime)/1000;
  lastTime=now;
  rawDt=Math.min(rawDt,0.05);

  /* Advance baseHue even on start screen */
  if(state==='start') baseHue=(baseHue+rawDt*8)%360;

  update(rawDt);
  draw();
}
requestAnimationFrame(loop);

})();
</script>
</body>
</html>
