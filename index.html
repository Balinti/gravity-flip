<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gravity Flip - Free HTML5 Game</title>
<meta name="description" content="Play Gravity Flip - Tap to flip gravity up/down while dodging obstacles from both sides. Collect stars for bonus points. Obstacles speed up gradually.">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0a1a">
<meta property="og:type" content="website">
<meta property="og:title" content="Gravity Flip - Free HTML5 Game">
<meta property="og:description" content="Tap to flip gravity up/down while dodging obstacles. Collect multiplier cells, pass through pulse gates for big bonuses!">
<meta property="og:url" content="https://balinti.github.io/gravity-flip/">
<meta property="og:image" content="https://balinti.github.io/gravity-flip/og-image.png">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4099346100621490" crossorigin="anonymous"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#0a0a1a;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;color:#fff;touch-action:none;user-select:none;-webkit-user-select:none}
#wrap{position:relative;width:100%;max-width:420px;height:100vh;max-height:750px;margin:0 auto;overflow:hidden}
canvas{display:block;width:100%;height:100%;background:#0a0a1a}
#ui-overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;display:flex;flex-direction:column;align-items:center;justify-content:center}
.panel{pointer-events:auto;text-align:center;display:none;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
#start-panel .title{font-size:2.4em;font-weight:900;letter-spacing:2px;text-shadow:0 0 30px rgba(100,200,255,.5);margin-bottom:8px}
#start-panel .sub{font-size:1.1em;opacity:.65;margin-bottom:6px;font-weight:300}
#start-panel .how{font-size:.78em;opacity:.45;margin-bottom:22px;line-height:1.5;max-width:280px}
#start-panel .tap{font-size:1.2em;opacity:.9;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:.9}50%{opacity:.4}}
#go-panel .go-title{font-size:1.8em;font-weight:700;color:#ff4466;margin-bottom:16px}
#go-panel .score-line{font-size:1.4em;margin:6px 0}
#go-panel .best-line{font-size:1em;opacity:.7;margin-bottom:20px}
#go-panel .tap{font-size:1.1em;opacity:.9;animation:pulse 1.5s infinite}
#footer{position:absolute;bottom:8px;left:0;width:100%;text-align:center;font-size:.65em;opacity:.4;pointer-events:auto}
#footer a{color:#aac;text-decoration:none}
#footer a:hover{text-decoration:underline}
#privacy-section{display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(10,10,26,.97);z-index:100;pointer-events:auto;padding:30px 20px;overflow-y:auto}
#privacy-section h2{margin-bottom:12px}
#privacy-section p{font-size:.85em;opacity:.8;line-height:1.5;margin-bottom:10px}
#privacy-section .close-btn{margin-top:16px;padding:8px 24px;background:#334;border:none;color:#fff;border-radius:6px;cursor:pointer;font-size:1em}
</style>
</head>
<body>
<div id="wrap">
<canvas id="c"></canvas>
<div id="ui-overlay">
<div class="panel" id="start-panel">
<div class="title">GRAVITY FLIP</div>
<div class="sub">Pulse Runner</div>
<div class="how">Tap to flip gravity &amp; activate Pulse.<br>Dodge blocks. Match your pulse color to gates for bonus!</div>
<div class="tap">Tap to Start</div>
</div>
<div class="panel" id="go-panel">
<div class="go-title">GAME OVER</div>
<div class="score-line">Score: <span id="final-score">0</span></div>
<div class="best-line">Best: <span id="best-score">0</span></div>
<div class="tap">Tap to Retry</div>
</div>
</div>
<div id="footer">
<a href="#" id="privacy-link">Privacy Policy</a> &middot; Gravity Flip &copy; 2025
</div>
<div id="privacy-section">
<h2>Privacy Policy</h2>
<p>This game stores your high score locally on your device using localStorage. No personal data is collected or transmitted.</p>
<p>Third-party ad services (Google AdSense) may use cookies to serve ads. See <a href="https://policies.google.com/privacy" target="_blank" rel="noopener" style="color:#8af">Google's Privacy Policy</a> for details.</p>
<button class="close-btn" id="privacy-close">Close</button>
</div>
</div>

<p style="position:absolute;bottom:-9999px">Gravity Flip is a free hyper-casual HTML5 game. Flip gravity to dodge obstacles and pass through pulse gates for bonus points. Play now in your browser!</p>

<script>
(()=>{
'use strict';

const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
const wrap=document.getElementById('wrap');
const startPanel=document.getElementById('start-panel');
const goPanel=document.getElementById('go-panel');
const finalScoreEl=document.getElementById('final-score');
const bestScoreEl=document.getElementById('best-score');

// Privacy toggle
document.getElementById('privacy-link').addEventListener('click',e=>{
  e.preventDefault();
  document.getElementById('privacy-section').style.display='block';
});
document.getElementById('privacy-close').addEventListener('click',()=>{
  document.getElementById('privacy-section').style.display='none';
});

// === CONSTANTS ===
const W=420,H=750;
const FLOOR_Y=H-80;
const CEIL_Y=80;
const LANE_FLOOR=FLOOR_Y-26;
const LANE_CEIL=CEIL_Y+26;
const PLAYER_X=80;
const PLAYER_R=14;
const GRAVITY=3200;
const FLIP_VEL=700;
const PULSE_DUR=0.35;
const BLOCK_W=42,BLOCK_H=50;
const GATE_W=38,GATE_H=54;
const CELL_R=10;
const NEAR_MISS_THRESH=14;
const BASE_SPEED=210;
const MAX_SPEED=440;
const TELEGRAPH=0.55;

const PALETTE=[0,30,55,120,180,220,270,320];
const PALETTE_LEN=PALETTE.length;

// === STATE ===
let state='start';
let score,dispScore,best;
let pY,pVY,pLane;
let pulseT,pulseHi,pulseUsed;
let mult,mMeter,mCap,mDecayT;
let obs,cells,parts;
let gTime,spawnT,pQueue;
let spd,dist;
let skX,skY,skD;
let dpr,cw,ch;
let lastT=0;
let hueOff=0;
let nmFlash=0;

best=parseInt(localStorage.getItem('gf_best2'))||0;

// === CANVAS RESIZE ===
function resize(){
  const r=wrap.getBoundingClientRect();
  dpr=Math.min(window.devicePixelRatio||1,2.5);
  cw=r.width;ch=r.height;
  canvas.width=cw*dpr;
  canvas.height=ch*dpr;
  canvas.style.width=cw+'px';
  canvas.style.height=ch+'px';
}
resize();
window.addEventListener('resize',resize);

// === UTIL ===
function lerp(a,b,t){return a+(b-a)*t}
function clamp(v,lo,hi){return v<lo?lo:v>hi?hi:v}
function rnd(a,b){return a+Math.random()*(b-a)}
function rndI(a,b){return Math.floor(rnd(a,b+1))}
function hsl(h,s,l,a){return a!==undefined?`hsla(${((h%360)+360)%360},${s}%,${l}%,${a})`:`hsl(${((h%360)+360)%360},${s}%,${l}%)`}
function hueDist(a,b){let d=Math.abs(a-b);return d>180?360-d:d}

// === PARTICLES ===
function emitP(x,y,n,hue,spd,life){
  for(let i=0;i<n;i++){
    const a=rnd(0,Math.PI*2),v=rnd(spd*.3,spd);
    parts.push({x,y,vx:Math.cos(a)*v,vy:Math.sin(a)*v,life:rnd(life*.5,life),ml:life,hue:hue+rnd(-20,20),r:rnd(2,5)});
  }
}
function emitRing(x,y,hue){
  for(let i=0;i<24;i++){
    const a=(Math.PI*2/24)*i,v=rnd(120,280);
    parts.push({x,y,vx:Math.cos(a)*v,vy:Math.sin(a)*v,life:.45,ml:.45,hue,r:rnd(3,6)});
  }
}

// === SHAKE ===
function shake(int,dur){skX=rnd(-int,int);skY=rnd(-int,int);skD=dur}

// === PATTERNS ===
function genPattern(){
  const diff=clamp(gTime/55,0,1);
  const q=[];
  const r=Math.random();

  if(r<0.25){
    const l=rndI(0,1);
    q.push({lane:l,type:'block',delay:0});
  }else if(r<0.42){
    const l=rndI(0,1);
    q.push({lane:l,type:'block',delay:0});
    q.push({lane:1-l,type:'gate',delay:0.32+rnd(0,.08)});
  }else if(r<0.56){
    const l=rndI(0,1);
    q.push({lane:l,type:'gate',delay:0});
    q.push({lane:1-l,type:'block',delay:0.38+rnd(0,.08)});
  }else if(r<0.7){
    const l=rndI(0,1);
    q.push({lane:l,type:'block',delay:0});
    q.push({lane:1-l,type:'block',delay:0.38-diff*.08});
  }else if(r<0.82){
    const l=rndI(0,1);
    q.push({lane:l,type:'block',delay:0});
    q.push({lane:l,type:'gate',delay:0.55-diff*.08});
  }else if(r<0.92){
    const l=rndI(0,1);
    q.push({lane:1-l,type:'cell',delay:0});
    q.push({lane:l,type:'block',delay:0.12});
  }else{
    // Alternator: 3 blocks alternating lanes
    const l=rndI(0,1);
    q.push({lane:l,type:'block',delay:0});
    q.push({lane:1-l,type:'block',delay:0.35-diff*.06});
    q.push({lane:l,type:'block',delay:0.7-diff*.12});
  }

  // Extra complexity at higher diff
  if(diff>0.35&&Math.random()<diff*0.35){
    const last=q[q.length-1];
    const ed=last.delay+0.33;
    q.push({lane:rndI(0,1),type:Math.random()<0.4?'gate':'block',delay:ed});
  }

  return q;
}

// === SPAWN ===
function spawnObs(lane,type){
  const y=lane===0?LANE_FLOOR:LANE_CEIL;
  if(type==='block'){
    obs.push({x:W+35,y,lane,type:'block',w:BLOCK_W,h:BLOCK_H,passed:false});
  }else if(type==='gate'){
    const gh=PALETTE[rndI(0,PALETTE_LEN-1)];
    obs.push({x:W+35,y,lane,type:'gate',w:GATE_W,h:GATE_H,hue:gh,tele:TELEGRAPH,armed:false,collected:false,passed:false});
  }else{
    cells.push({x:W+35,y,lane,r:CELL_R,collected:false,bob:rnd(0,Math.PI*2)});
  }
}

// === INIT ===
function init(){
  score=0;dispScore=0;
  pY=LANE_FLOOR;pVY=0;pLane=0;
  pulseT=0;pulseHi=0;pulseUsed=false;
  mult=1;mMeter=0;mCap=3;mDecayT=5.5;
  obs=[];cells=[];parts=[];
  gTime=0;spawnT=0;pQueue=[];
  spd=BASE_SPEED;dist=0;
  skX=0;skY=0;skD=0;
  nmFlash=0;hueOff=0;
}

// === INPUT ===
function doFlip(){
  if(state==='start'){
    state='playing';startPanel.style.display='none';goPanel.style.display='none';init();return;
  }
  if(state==='gameover'){
    state='playing';goPanel.style.display='none';init();return;
  }
  if(state==='playing'){
    pLane=1-pLane;
    pVY=pLane===1?-FLIP_VEL:FLIP_VEL;
    pulseT=PULSE_DUR;
    pulseHi=(pulseHi+1)%PALETTE_LEN;
    pulseUsed=false;
    shake(3,.1);
    emitP(PLAYER_X,pY,8,PALETTE[pulseHi],160,.4);
  }
}

wrap.addEventListener('pointerdown',e=>{e.preventDefault();doFlip()});
document.addEventListener('keydown',e=>{
  if(e.code==='Space'||e.code==='Enter'){e.preventDefault();doFlip()}
});

// === DEATH ===
function die(){
  state='gameover';
  const fs=Math.floor(score);
  if(fs>best){best=fs;localStorage.setItem('gf_best2',best)}
  finalScoreEl.textContent=fs;
  bestScoreEl.textContent=best;
  goPanel.style.display='block';
  shake(14,.4);
  emitP(PLAYER_X,pY,35,0,320,.8);
  emitP(PLAYER_X,pY,20,40,260,.6);
}

// === COLLISION ===
function rectCirc(rx,ry,rw,rh,cx,cy,cr){
  const nx=clamp(cx,rx-rw/2,rx+rw/2);
  const ny=clamp(cy,ry-rh/2,ry+rh/2);
  const dx=cx-nx,dy=cy-ny;
  return dx*dx+dy*dy<cr*cr;
}

// === UPDATE ===
function update(dt){
  if(state!=='playing')return;

  gTime+=dt;
  hueOff+=dt*25;
  dist+=spd*dt;
  score+=spd*dt*0.012*mult;

  // Speed ramp
  spd=Math.min(BASE_SPEED+gTime*2.8,MAX_SPEED);

  // Mult cap ramp
  mCap=Math.min(3+Math.floor(gTime/18)*2,9);

  // Mult decay
  mDecayT-=dt;
  if(mDecayT<=0){
    if(mult>1)mult=Math.max(1,mult-1);
    mDecayT=5.5;
  }

  // Meter passive decay
  mMeter=Math.max(0,mMeter-dt*0.06);

  // Player physics
  const gDir=pLane===0?1:-1;
  pVY+=GRAVITY*gDir*dt;
  pY+=pVY*dt;

  if(pLane===0&&pY>=LANE_FLOOR){pY=LANE_FLOOR;pVY=0}
  else if(pLane===1&&pY<=LANE_CEIL){pY=LANE_CEIL;pVY=0}

  // Pulse
  if(pulseT>0)pulseT-=dt;

  // Spawn
  spawnT-=dt;
  if(pQueue.length===0&&spawnT<=0){
    pQueue=genPattern();
    spawnT=Math.max(1.05-gTime*0.005,0.4);
  }

  for(let i=pQueue.length-1;i>=0;i--){
    pQueue[i].delay-=dt;
    if(pQueue[i].delay<=0){
      const p=pQueue.splice(i,1)[0];
      spawnObs(p.lane,p.type);
    }
  }

  // Obstacles
  for(let i=obs.length-1;i>=0;i--){
    const o=obs[i];
    o.x-=spd*dt;

    if(o.type==='gate'&&o.tele>0){
      o.tele-=dt;
      if(o.tele<=0)o.armed=true;
    }

    if(o.x<-65){obs.splice(i,1);continue}

    // Pass check (near miss)
    if(!o.passed&&o.x+o.w/2<PLAYER_X-PLAYER_R){
      o.passed=true;
      if(o.type==='block'){
        const dy=Math.abs(pY-o.y);
        if(dy<o.h/2+PLAYER_R+NEAR_MISS_THRESH&&o.lane!==pLane){
          score+=5*mult;
          nmFlash=.25;
          emitP(PLAYER_X,pY,5,55,90,.3);
        }
      }
    }

    // Collision
    if(rectCirc(o.x,o.y,o.w,o.h,PLAYER_X,pY,PLAYER_R-2)){
      if(o.type==='block'){die();return}
      else if(o.type==='gate'){
        if(!o.armed){
          // telegraph: pass through
        }else if(o.collected){
          // already collected: pass through
        }else{
          // armed, not collected
          if(pulseT>0&&!pulseUsed&&hueDist(PALETTE[pulseHi],o.hue)<=30){
            o.collected=true;
            pulseUsed=true;
            score+=50*mult;
            mMeter=Math.min(mMeter+0.35,1);
            if(mMeter>=1&&mult<mCap){mult++;mMeter=0}
            mDecayT=5.5;
            shake(4,.15);
            emitRing(o.x,o.y,o.hue);
          }else{
            die();return;
          }
        }
      }
    }
  }

  // Cells
  for(let i=cells.length-1;i>=0;i--){
    const c=cells[i];
    c.x-=spd*dt;
    c.bob+=dt*4;
    if(c.x<-30){cells.splice(i,1);continue}
    if(!c.collected){
      const dx=PLAYER_X-c.x,dy=pY-(c.y+Math.sin(c.bob)*4);
      if(dx*dx+dy*dy<(PLAYER_R+c.r)*(PLAYER_R+c.r)){
        c.collected=true;
        mMeter=Math.min(mMeter+0.2,1);
        if(mMeter>=1&&mult<mCap){mult++;mMeter=0}
        mDecayT=5.5;
        score+=10*mult;
        emitP(c.x,c.y,8,160,130,.4);
      }
    }
  }

  // Shake decay
  if(skD>0){skD-=dt;skX*=.88;skY*=.88}else{skX=0;skY=0}

  // Near miss flash
  if(nmFlash>0)nmFlash-=dt;

  // Particles
  for(let i=parts.length-1;i>=0;i--){
    const p=parts[i];
    p.x+=p.vx*dt;p.y+=p.vy*dt;
    p.life-=dt;p.vx*=.96;p.vy*=.96;
    if(p.life<=0)parts.splice(i,1);
  }

  dispScore=lerp(dispScore,score,dt*10);
}

// === DRAW ===
function draw(){
  const sx=cw/W,sy=ch/H;
  const s=Math.min(sx,sy);

  ctx.save();
  ctx.scale(dpr,dpr);

  // BG gradient
  const bg=ctx.createLinearGradient(0,0,0,ch);
  bg.addColorStop(0,'#080818');
  bg.addColorStop(.5,'#0c0f28');
  bg.addColorStop(1,'#080818');
  ctx.fillStyle=bg;
  ctx.fillRect(0,0,cw,ch);

  // Center
  const ox=(cw-W*s)/2,oy=(ch-H*s)/2;
  ctx.translate(ox,oy);
  ctx.scale(s,s);

  // Shake
  if(skD>0)ctx.translate(skX,skY);

  // Lane lines
  ctx.strokeStyle='rgba(255,255,255,0.07)';
  ctx.lineWidth=1;
  ctx.setLineDash([6,8]);
  ctx.beginPath();
  ctx.moveTo(0,FLOOR_Y);ctx.lineTo(W,FLOOR_Y);
  ctx.moveTo(0,CEIL_Y);ctx.lineTo(W,CEIL_Y);
  ctx.stroke();
  ctx.setLineDash([]);

  // Scrolling grid dots
  ctx.fillStyle='rgba(255,255,255,0.025)';
  const gOff=(dist*.4)%40;
  for(let gx=-gOff;gx<W+40;gx+=40){
    for(let gy=CEIL_Y+20;gy<FLOOR_Y;gy+=40){
      ctx.fillRect(gx,gy,1.5,1.5);
    }
  }

  if(state==='playing'||state==='gameover'){
    // --- OBSTACLES ---
    for(const o of obs){
      ctx.shadowBlur=0;
      if(o.type==='block'){
        // Block body
        const bx=o.x-o.w/2,by=o.y-o.h/2;
        const bGrad=ctx.createLinearGradient(bx,by,bx,by+o.h);
        bGrad.addColorStop(0,hsl(355,65,52));
        bGrad.addColorStop(1,hsl(355,60,38));
        ctx.fillStyle=bGrad;
        ctx.shadowColor='rgba(255,60,80,0.35)';
        ctx.shadowBlur=12;
        // Rounded rect
        const cr=5;
        ctx.beginPath();
        ctx.moveTo(bx+cr,by);ctx.lineTo(bx+o.w-cr,by);ctx.quadraticCurveTo(bx+o.w,by,bx+o.w,by+cr);
        ctx.lineTo(bx+o.w,by+o.h-cr);ctx.quadraticCurveTo(bx+o.w,by+o.h,bx+o.w-cr,by+o.h);
        ctx.lineTo(bx+cr,by+o.h);ctx.quadraticCurveTo(bx,by+o.h,bx,by+o.h-cr);
        ctx.lineTo(bx,by+cr);ctx.quadraticCurveTo(bx,by,bx+cr,by);
        ctx.closePath();
        ctx.fill();
        // Highlight strip
        ctx.shadowBlur=0;
        ctx.fillStyle='rgba(255,180,180,0.18)';
        ctx.fillRect(bx+4,by+3,o.w-8,5);
        // Danger stripes
        ctx.strokeStyle='rgba(0,0,0,0.15)';
        ctx.lineWidth=2;
        for(let sx2=bx+6;sx2<bx+o.w;sx2+=8){
          ctx.beginPath();ctx.moveTo(sx2,by+o.h-8);ctx.lineTo(sx2+5,by+o.h-2);ctx.stroke();
        }
      }else if(o.type==='gate'){
        const alpha=o.tele>0?(.25+.15*Math.sin(gTime*12)):o.collected?.12:.92;
        const gh=o.hue;
        const gx=o.x-o.w/2,gy2=o.y-o.h/2;

        // Outer frame
        ctx.strokeStyle=hsl(gh,85,60,alpha);
        ctx.lineWidth=o.armed?3.5:1.5;
        ctx.shadowColor=hsl(gh,90,60,alpha*.5);
        ctx.shadowBlur=o.armed?18:6;

        // Diamond shape for gate
        ctx.beginPath();
        ctx.moveTo(o.x,gy2);
        ctx.lineTo(gx+o.w,o.y);
        ctx.lineTo(o.x,gy2+o.h);
        ctx.lineTo(gx,o.y);
        ctx.closePath();
        ctx.stroke();

        if(o.armed&&!o.collected){
          // Inner ring
          ctx.beginPath();
          ctx.arc(o.x,o.y,9,0,Math.PI*2);
          ctx.strokeStyle=hsl(gh,90,72,alpha*.65);
          ctx.lineWidth=2;
          ctx.stroke();
          // Color fill hint
          ctx.fillStyle=hsl(gh,80,55,alpha*.12);
          ctx.beginPath();
          ctx.moveTo(o.x,gy2+6);
          ctx.lineTo(gx+o.w-6,o.y);
          ctx.lineTo(o.x,gy2+o.h-6);
          ctx.lineTo(gx+6,o.y);
          ctx.closePath();
          ctx.fill();
        }
        ctx.shadowBlur=0;
      }
    }

    // --- CELLS ---
    for(const c of cells){
      if(c.collected)continue;
      const cy2=c.y+Math.sin(c.bob)*4;
      ctx.shadowColor=hsl(160,90,55,.4);
      ctx.shadowBlur=14;
      ctx.beginPath();ctx.arc(c.x,cy2,c.r,0,Math.PI*2);
      ctx.fillStyle=hsl(155+hueOff*.4,80,58,.88);
      ctx.fill();
      ctx.beginPath();ctx.arc(c.x,cy2,c.r*.45,0,Math.PI*2);
      ctx.fillStyle=hsl(155+hueOff*.4,90,82,.55);
      ctx.fill();
      ctx.shadowBlur=0;
    }

    // --- PLAYER ---
    const pH=PALETTE[pulseHi];
    const pActive=pulseT>0;

    // Trail
    if(state==='playing'){
      for(let t=1;t<=4;t++){
        const ta=.12*(5-t);
        ctx.beginPath();ctx.arc(PLAYER_X-t*7,pY,PLAYER_R-t*2,0,Math.PI*2);
        ctx.fillStyle=hsl(pH,60,50,ta);
        ctx.fill();
      }
    }

    // Pulse glow
    if(pActive){
      const pa=pulseT/PULSE_DUR;
      ctx.beginPath();ctx.arc(PLAYER_X,pY,PLAYER_R+14*pa,0,Math.PI*2);
      ctx.fillStyle=hsl(pH,80,60,.12*pa);
      ctx.fill();
      ctx.beginPath();ctx.arc(PLAYER_X,pY,PLAYER_R+7,0,Math.PI*2);
      ctx.strokeStyle=hsl(pH,90,70,.4*pa);
      ctx.lineWidth=2;ctx.stroke();
    }

    // Body
    ctx.beginPath();ctx.arc(PLAYER_X,pY,PLAYER_R,0,Math.PI*2);
    const pGrad=ctx.createRadialGradient(PLAYER_X-4,pY-4,2,PLAYER_X,pY,PLAYER_R);
    pGrad.addColorStop(0,hsl(pH,80,82));
    pGrad.addColorStop(1,hsl(pH,70,48));
    ctx.fillStyle=pGrad;
    ctx.shadowColor=hsl(pH,90,60,.5);
    ctx.shadowBlur=20;
    ctx.fill();
    ctx.shadowBlur=0;

    // Eye
    const eyeDir=pLane===0?-1:1;
    ctx.beginPath();ctx.arc(PLAYER_X+5,pY+eyeDir*-2,3.5,0,Math.PI*2);
    ctx.fillStyle='#fff';ctx.fill();
    ctx.beginPath();ctx.arc(PLAYER_X+6,pY+eyeDir*-2,1.8,0,Math.PI*2);
    ctx.fillStyle='#111';ctx.fill();

    // Pulse label
    if(pActive&&state==='playing'){
      ctx.fillStyle=hsl(pH,80,65,.85);
      ctx.font='bold 11px "Segoe UI",system-ui,sans-serif';
      ctx.textAlign='center';
      ctx.fillText('PULSE',PLAYER_X,pY-(pLane===0?PLAYER_R+12:-(PLAYER_R+6)));
    }

    // --- PARTICLES ---
    for(const p of parts){
      const a=p.life/p.ml;
      ctx.beginPath();ctx.arc(p.x,p.y,p.r*a,0,Math.PI*2);
      ctx.fillStyle=hsl(p.hue,80,65,a*.8);
      ctx.fill();
    }

    // Near miss flash overlay
    if(nmFlash>0){
      ctx.fillStyle=`rgba(255,255,100,${nmFlash*.12})`;
      ctx.fillRect(0,0,W,H);
    }

    // === HUD ===
    ctx.shadowBlur=0;
    // Score
    ctx.fillStyle='rgba(255,255,255,0.9)';
    ctx.font='bold 26px "Segoe UI",system-ui,sans-serif';
    ctx.textAlign='right';
    ctx.fillText(Math.floor(dispScore),W-18,42);

    // Multiplier
    if(mult>1){
      ctx.fillStyle=hsl(40+mult*22,90,62);
      ctx.font='bold 20px "Segoe UI",system-ui,sans-serif';
      ctx.textAlign='left';
      ctx.fillText('x'+mult,18,40);
    }

    // Mult meter bar
    ctx.fillStyle='rgba(255,255,255,0.12)';
    roundRect(ctx,18,52,64,6,3);ctx.fill();
    if(mMeter>0){
      ctx.fillStyle=hsl(110+mult*25,80,52);
      roundRect(ctx,18,52,64*mMeter,6,3);ctx.fill();
    }
  }

  ctx.restore();
}

function roundRect(c,x,y,w,h,r){
  c.beginPath();
  c.moveTo(x+r,y);c.lineTo(x+w-r,y);c.quadraticCurveTo(x+w,y,x+w,y+r);
  c.lineTo(x+w,y+h-r);c.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  c.lineTo(x+r,y+h);c.quadraticCurveTo(x,y+h,x,y+h-r);
  c.lineTo(x,y+r);c.quadraticCurveTo(x,y,x+r,y);
  c.closePath();
}

// === LOOP ===
function loop(ts){
  requestAnimationFrame(loop);
  if(!lastT){lastT=ts;return}
  let dt=(ts-lastT)/1000;
  lastT=ts;
  dt=Math.min(dt,.05);
  update(dt);
  draw();
}

// Show start screen
startPanel.style.display='block';
bestScoreEl.textContent=best;
requestAnimationFrame(loop);

})();
</script>
</body>
</html>